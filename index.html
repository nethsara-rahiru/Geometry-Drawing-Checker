<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geometry Drawing Checker</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f2f2f2;
    }
    h1 {
      text-align: center;
    }
    #canvas-wrapper {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    video, canvas, img {
      border: 1px solid #ccc;
      max-width: 100%;
      height: auto;
    }
    #feedback {
      background: #fff;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin: 0.5rem auto;
      display: block;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Geometry Drawing Checker</h1>

  <video id="video" width="320" height="240" autoplay></video>
  <button onclick="capturePhoto()">üì∏ Take Photo</button>

  <div id="canvas-wrapper">
    <div>
      <h3>Student Image</h3>
      <canvas id="studentCanvas" width="320" height="240"></canvas>
      <canvas id="redStudentCanvas" width="320" height="240"></canvas>
      <canvas id="blueStudentCanvas" width="320" height="240"></canvas>
      <canvas id="edgeStudentCanvas" width="320" height="240"></canvas>
    </div>
    <div>
      <h3>Reference Image</h3>
      <img id="referenceImg" src="answer.png" width="320" height="240" alt="Reference">
      <canvas id="referenceCanvas" width="320" height="240"></canvas>
    </div>
  </div>

  <button onclick="analyzeImages()">‚úÖ Check Drawing</button>
  <div id="feedback"></div>

  <script>
    const video = document.getElementById('video');
    const studentCanvas = document.getElementById('studentCanvas');
    const studentCtx = studentCanvas.getContext('2d');
    const redStudentCanvas = document.getElementById('redStudentCanvas');
    const redStudentCtx = redStudentCanvas.getContext('2d');
    const blueStudentCanvas = document.getElementById('blueStudentCanvas');
    const blueStudentCtx = blueStudentCanvas.getContext('2d');
    const edgeStudentCanvas = document.getElementById('edgeStudentCanvas');
    const edgeStudentCtx = edgeStudentCanvas.getContext('2d');
    const referenceImg = document.getElementById('referenceImg');
    const referenceCanvas = document.getElementById('referenceCanvas');
    const referenceCtx = referenceCanvas.getContext('2d');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      });

    function capturePhoto() {
      studentCtx.drawImage(video, 0, 0, studentCanvas.width, studentCanvas.height);
    }

    referenceImg.onload = () => {
      referenceCtx.drawImage(referenceImg, 0, 0, referenceCanvas.width, referenceCanvas.height);
    }

    function analyzeImages() {
      if (typeof cv === 'undefined') {
        alert("OpenCV is not loaded yet. Please wait a few seconds.");
        return;
      }

      const feedback = document.getElementById('feedback');
      feedback.innerHTML = "Analyzing...";

      let srcStudent = cv.imread(studentCanvas);
      let srcRef = cv.imread(referenceCanvas);

      let hsvStudent = new cv.Mat();
      let hsvRef = new cv.Mat();
      cv.cvtColor(srcStudent, hsvStudent, cv.COLOR_RGBA2RGB);
      cv.cvtColor(hsvStudent, hsvStudent, cv.COLOR_RGB2HSV);
      cv.cvtColor(srcRef, hsvRef, cv.COLOR_RGBA2RGB);
      cv.cvtColor(hsvRef, hsvRef, cv.COLOR_RGB2HSV);

      let lowRed = new cv.Mat(hsvRef.rows, hsvRef.cols, hsvRef.type(), [0, 100, 100, 0]);
      let highRed = new cv.Mat(hsvRef.rows, hsvRef.cols, hsvRef.type(), [10, 255, 255, 255]);
      let redStudent = new cv.Mat();
      cv.inRange(hsvStudent, lowRed, highRed, redStudent);
      cv.imshow("redStudentCanvas", redStudent);

      let lowBlue = new cv.Mat(hsvRef.rows, hsvRef.cols, hsvRef.type(), [100, 100, 100, 0]);
      let highBlue = new cv.Mat(hsvRef.rows, hsvRef.cols, hsvRef.type(), [130, 255, 255, 255]);
      let blueStudent = new cv.Mat();
      cv.inRange(hsvStudent, lowBlue, highBlue, blueStudent);
      cv.imshow("blueStudentCanvas", blueStudent);

      let grayStudent = new cv.Mat();
      let edgesStudent = new cv.Mat();
      cv.cvtColor(srcStudent, grayStudent, cv.COLOR_RGBA2GRAY);
      cv.Canny(grayStudent, edgesStudent, 50, 150);
      cv.imshow("edgeStudentCanvas", edgesStudent);

      let srcRefRed = new cv.Mat();
      cv.inRange(hsvRef, lowRed, highRed, srcRefRed);
      let redCountRef = cv.countNonZero(srcRefRed);
      let redCountStudent = cv.countNonZero(redStudent);
      let redMatch = Math.min(redCountStudent / redCountRef, 1.0);

      let srcRefBlue = new cv.Mat();
      cv.inRange(hsvRef, lowBlue, highBlue, srcRefBlue);
      let blueCountRef = cv.countNonZero(srcRefBlue);
      let blueCountStudent = cv.countNonZero(blueStudent);
      let blueMatch = Math.min(blueCountStudent / blueCountRef, 1.0);

      let grayRef = new cv.Mat();
      let edgesRef = new cv.Mat();
      cv.cvtColor(srcRef, grayRef, cv.COLOR_RGBA2GRAY);
      cv.Canny(grayRef, edgesRef, 50, 150);
      let edgeCountStudent = cv.countNonZero(edgesStudent);
      let edgeCountRef = cv.countNonZero(edgesRef);
      let structureMatch = Math.min(edgeCountStudent / edgeCountRef, 1.0);

      let total = 0;
      let out = "<h3>Feedback</h3><ul>";
      if (structureMatch > 0.7) { total += 3; out += "<li>‚úÖ Basic structure drawn correctly</li>"; }
      else { out += "<li>‚ùå Structure not matched</li>"; }

      if (redMatch > 0.6) { total += 3; out += "<li>‚úÖ Required red points/lines present</li>"; }
      else { out += "<li>‚ùå Missing red lines/points</li>"; }

      if (blueMatch > 0.5) { total += 2; out += "<li>‚úÖ Labels detected</li>"; }
      else { out += "<li>‚ùå Labels missing or incorrect</li>"; }

      out += `</ul><h2>Total Score: ${total} / 8</h2>`;
      feedback.innerHTML = out;

      // Cleanup
      srcStudent.delete(); srcRef.delete(); hsvStudent.delete(); hsvRef.delete();
      redStudent.delete(); blueStudent.delete(); lowRed.delete(); highRed.delete();
      lowBlue.delete(); highBlue.delete(); srcRefRed.delete(); srcRefBlue.delete();
      grayStudent.delete(); edgesStudent.delete(); grayRef.delete(); edgesRef.delete();
    }
  </script>
</body>
</html>
